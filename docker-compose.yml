version: '2'
services:
  database:
    container_name: workshop-database
    environment:
      - MYSQL_ROOT_PASSWORD=workshop
    ports:
     - "9000:3306"
    image: "mariadb"
  init:
    container_name: workshop-init
    build: docker/moby-dick
    volumes:
     - ./apps/monolith:/code
    command: ["./bin/init.sh"]
  monolith:
    container_name: workshop-monolith
    build: docker/moby-dick
    ports:
     - "8001:80"
    volumes:
     - ./apps/monolith:/code
    depends_on:
      - database
      - init
      - recipe

  # ------------------
  # recipe
  # ------------------
  recipe-database:
    container_name: workshop-recipe-database
    environment:
      - MYSQL_ROOT_PASSWORD=workshop
    ports:
     - "9002:3306"
    image: "mariadb"
  recipe-init:
    container_name: workshop-recipe-init
    build: docker/moby-dick-upgrade
    volumes:
     - ./apps/recipe:/code
    command: ["./bin/init.sh"]
  recipe:
    container_name: workshop-recipe
    build: docker/moby-dick-upgrade
    ports:
     - "8002:80"
    volumes:
     - ./apps/recipe:/code
    depends_on:
      - recipe-database
      - recipe-init

  # ------------------
  # newsletter
  # ------------------
  newsletter:
    container_name: workshop-newsletter
    build: docker/moby-dick
    ports:
     - "8003:80"
    volumes:
     - ./apps/newsletter:/code

  # ------------------
  # user
  # ------------------
  user-database:
    container_name: workshop-user-database
    environment:
      - MYSQL_ROOT_PASSWORD=workshop
    ports:
     - "9004:3306"
    image: "mariadb"
  user-init:
    container_name: workshop-user-init
    build: docker/moby-dick
    volumes:
     - ./apps/user:/code
    command: ["./bin/init.sh"]
  user:
    container_name: workshop-user
    build: docker/moby-dick
    ports:
     - "8004:80"
    volumes:
     - ./apps/user:/code
    depends_on:
      - user-database
      - user-init

  varnish:
    container_name: workshop-varnish
    ports:
     - "8000:80"
    build: docker/varnish
    depends_on:
      - monolith
      - newsletter
      - user



